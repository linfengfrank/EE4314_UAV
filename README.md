# Quadrotor Simulation for EE4314

This repository contains a simulation framework for a small quadrotor, developed for the **EE4314** course.  

## Components
1. **Dynamic Model** â€“ models the quadrotorâ€™s physical dynamics  
2. **Flight Control** â€“ implements position and attitude controllers  
3. **Trajectory Generation** â€“ provides reference paths for flight simulation  


---
## ðŸš€ Quick Run Guidance: Circular Trajectory Demo

This demo generates a **constant-speed circular trajectory** in the NED frame and runs it through the provided Simulink position control model.  

### 1. Setup
- Download and extract the entire repository.  
- Open **MATLAB**

### 2. Run the Script
- Open **`circle_traj_demo.m`** in MATLAB.  
- Click **Run** (or press `F5`).

---

## Flight Control (optional, provided as reference)

### Position and Velocity Control

The original PX4 firmware employs a P+PID control structure for position and velocity control. However, its tracking performance falls short in achieving agile flight. To address this, we've implemented the robust perfect tracking (RPT) control method for position-velocity control. Subsequently, we'll introduce both the P+PID and RPT control laws in the following sections


#### P+PID Control

Outer-loop position control involves only proportional control. The desired velocity generated from the position error is added to the feedforward of the desired velocity, creating the overall desired velocity $V_{\rm sp}$. 

$$V_{\rm sp} = K_{\rm p, \ pos} (P_{\rm ref}-P)+V_{\rm ref}$$

where $K_{\rm p, \ pos} = {\rm diag}(K_{\rm p, x}, K_{\rm p, y}, K_{\rm p, z})$, and $V_{\rm ref}$ is the feedforward desired velocity generated by the trajectory generation. 

The PID control computes the desired acceleration. The desired acceleration generated from velocity error is added to the feedforward of the desired acceleration, forming the overall desired acceleration. This operates on the same principle as position control.

$${\mathbf a_{\rm sp}}=K_{\rm p, \ vel}(V_{\rm sp}-V) + K_{\rm i, \ vel}\int(V_{\rm sp}-V)dt + K_{\rm d, \ vel}(-\dot{V}) + {\mathbf a}_{\rm ref}$$

where $${\mathbf a}_{\rm ref}$$ is the feedforward desired acceleration generated by the trajectory generation. The contol parameters are defined as follows: $K_{\rm p, \ vel} = {\rm diag}(K_{\rm p, vx}, K_{\rm p, vy}, K_{\rm p, vz})$, $K_{\rm i, \ vel} = {\rm diag}(K_{\rm i, vx}, K_{\rm i, vy}, K_{\rm i, vz})$, and $K_{\rm d, \ vel} = {\rm diag}(K_{\rm d, vx}, K_{\rm d, vy}, K_{\rm d, vz})$. 


| Control Paramter          |     PX4 Parameter        | Value       |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm p, x}$            | MPC\_XY\_P               | 2.2         |
| $K_{\rm p, y}$            | MPC\_XY\_P               | 2.2         |
| $K_{\rm p, z}$            | MPC\_XY\_P               | 0.8         |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm p, vx}$           | MPC\_XY\_VEL\_P\_ACC     | 4.0         |
| $K_{\rm p, vy}$           | MPC\_XY\_VEL\_P\_ACC     | 4.0         |
| $K_{\rm p, vz}$           | MPC\_Z\_VEL\_P\_ACC      | 4.0         |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm i, vx}$           | MPC\_XY\_VEL\_I\_ACC     | 0.4         |
| $K_{\rm i, vy}$           | MPC\_XY\_VEL\_I\_ACC     | 0.4         |
| $K_{\rm i, vz}$           | MPC\_Z\_VEL\_I\_ACC      | 2.0         |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm d, vx}$           | MPC\_XY\_VEL\_D\_ACC     | 0.2         |
| $K_{\rm d, vy}$           | MPC\_XY\_VEL\_D\_ACC     | 0.2         |
| $K_{\rm d, vz}$           | MPC\_Z\_VEL\_D\_ACC      | 0.0         |
|-------------------------- | ------------------------ | ----------- |


#### Robust Perfect Tracking Control

The RPT control law can be formulated as follows:

$${\mathbf a_{\rm sp} }=\begin{bmatrix} a_{\rm x, \ sp} \\ a_{\rm y, \ sp} \\ a_{\rm z, \ sp}\end{bmatrix}=F_{\rm I}\int(P_{\rm ref}-P)dt + F_{\rm p}(P_{\rm ref}-P) + F_{\rm v}(V_{\rm ref}-V)+{\mathbf a_{\rm ref}}$$

with

$$F_{\rm I}
=\begin{bmatrix} 
\displaystyle \frac{k_{\rm i,xy}\omega_{\rm n, xy}^2}{\epsilon_{\rm xy}^3} & 
\displaystyle \frac{k_{\rm i,xy}\omega_{\rm n, xy}^2}{\epsilon_{\rm xy}^3} & 
\displaystyle \frac{k_{\rm i,z}\omega_{\rm n, z}^2}{\epsilon_{\rm z}^3}
\end{bmatrix}^\intercal$$

$$F_{\rm p} = 
\begin{bmatrix} 
\displaystyle \frac{\omega_{\rm n, xy}^2 + 2\zeta_{\rm xy}\omega_{\rm n, xy}k_{\rm i,xy}}{\epsilon_{\rm xy}^2} & 
\displaystyle \frac{\omega_{\rm n, xy}^2 + 2\zeta_{\rm xy}\omega_{\rm n, xy}k_{\rm i,xy}}{\epsilon_{\rm xy}^2} & 
\displaystyle \frac{\omega_{\rm n, z}^2 + 2\zeta_{\rm z}\omega_{\rm n, zy}k_{\rm i,z}}{\epsilon_{\rm z}^2}
\end{bmatrix}^\intercal
$$

$$F_{\rm v} = 
\begin{bmatrix} 
\displaystyle \frac{2\zeta_{\rm xy}\omega_{\rm n, xy} + k_{\rm i,xy}}{\epsilon_{\rm xy}} & 
\displaystyle \frac{2\zeta_{\rm xy}\omega_{\rm n, xy} + k_{\rm i,xy}}{\epsilon_{\rm xy}}  & 
\displaystyle \frac{2\zeta_{\rm z}\omega_{\rm n, z} + k_{\rm i,z}}{\epsilon_{\rm z}} 
\end{bmatrix}^\intercal
$$

where $\epsilon_{\rm xy}$ and $\epsilon_{\rm z}$ are the design parameters to adjust the settling time of the closed-loop system in horizontal and vertical directions respectively. $(\omega_{\rm n, xy}, \omega_{\rm n, z})$, $(\zeta_{\rm xy}, \zeta_{\rm z})$ and $(k_{\rm i, xy}, k_{\rm i, z})$ are respectively the nominal natural frequency, damping ratio and desired pole location of the closed-loop system. 

| Control Parameter         |    Value       |
|-------------------------- | -------------- | 
| $\omega_{\rm n, xy}$      | 0.4            |
| $\zeta_{\rm xy}$          | 1.65           |
| $k_{\rm i}$               | 1.2            |
| $\epsilon_{\rm xy}$       | 0.4            |
|-------------------------- | -------------- | 
| $\omega_{\rm n, xy}$      | 0.5            |
| $\zeta_{\rm xy}$          | 1.65           |
| $k_{\rm i}$               | 1.2            |
| $\epsilon_{\rm xy}$       | 0.5            |


and 

| Control Gain          |    Value       |
|-------------------------- | -------------- | 
| $F_{\rm I}$          | $[3.0, 3.0, 2.4]^{\intercal}$            |
| $F_{\rm P}$          | $[10.9, 10.9, 8.92]^{\intercal}$            |
| $F_{\rm V}$          | $[6.3, 6.3, 5.7]^{\intercal}$            |




#### Convert Desired Acceleration to Thrust Vector

Calculate the desired thrust vector based on the above obtained acceleration. Calculate the normalized resultant force vector, which represents the Z-axis vector of the aircraft, used for attitude control. We observe that the desired $z_{\rm B}$ direction is along the desired thrust vecotr or acceleration vector:

$$ z_{\rm B, \ sp} = \frac{ -{\mathbf a_{\rm sp}} + g{\mathbf e_3} }{ || -{\mathbf a}_{\rm sp} + g{\mathbf e_3} ||} $$

Please note the calcualtion of $z_{\rm B, \ sp}$ in the simulator is different from PX4 orginal code, which will assume $\mathbf a_{\rm sp}(3)=0$.

The tilt angle of $z_{\rm B, \ sp}$ will be limited, which represents the maximum inclination of the desired attitude generated. The procedure for restricting this angle is as follows: first, perform a dot product between the aircraft's Z-axis vector and the normalized geographical Z-axis vector to obtain the cosine of the angle between the two vectors. Then, calculate the inverse cosine to derive the tilt angle. Finally, apply constraints to limit this angle.

Calculate the collective thurst based on hovering throttle and acceleration in z-axis.

$$ F_{\rm col} = \frac{a(3) T_{\rm hover}}{g} - T_{\rm hover}$$


The total force is not only used for hovering but also for horizontal movement, hence the need to consider the tilt angle. The cosine value of the tilt angle is calculated through vector dot product.

#### Thrust Constrains
  
Prioritize vertical control while keeping a horizontal margin. The thurst vector in the xy plane is constrained by the parameter of  MPC\_THR\_XY\_MARG. 

$$F_{\rm xy} < {\rm  MPC\_THR\_XY\_MARG}$$

and total thurst vector is constrained by the parameter of  MPC\_THR\_MAX


#### Convert Desired Thrust Vector to Attitude

$\psi_{\rm sp}$ is the specified yaw angle. Based on that, we can derive the projection of the desired body axis X-axis unit vector onto the NED coordinate system's XY plane  (the intermediate frame $C$) as

$$x_{\rm C, \ sp}=[\cos{\psi_{\rm sp}}, \ \sin{\psi_{\rm sp}}, \  0]^{\intercal}$$
 
and $y_{\rm C, \ sp}$ represents the vector obtained by rotating the projection vector to the left by 90 degrees (by exchanging x and y coordinates and adding a negative sign to the new vector's x-coordinate to signify the left turn), which is given below

$$y_{\rm C, \ sp}=[-\sin{\psi_{\rm sp}}, \ \cos{\psi_{\rm sp}}, \  0]^{\intercal}$$
 
According to spatial geometric properties, $y_{\rm C, \ sp}$ vector is also perpendicular to the desired body axis X-axis. Using the cross product of $y_{\rm C, \ sp}$ and body_z gives us body_x. 

$$ x_{\rm B, \ sp} = y_{\rm C, \ sp} \times  z_{\rm B, \ sp} $$
 
 <!-- (line x perpendicular to line y's projection y' within plane a implies line x is perpendicular to line y - because: line x is perpendicular to projection y', the perpendicular from line y to plane a is perpendicular to line x; hence, line x is perpendicular to the plane formed by the projection y' and the perpendicular, and line y is within the plane formed by the projection y' and the perpendicular, therefore line x is perpendicular to line y). -->


The desired body Y-axis vector $y_{\rm B, \ sp}$ can be obtained by taking the cross product of the desired body Z-axis vector $z_{\rm B, \ sp}$ and the desired body X-axis vector $x_{\rm B, \ sp}$ as follows:

$$ y_{\rm B, \ sp} = z_{\rm B, \ sp} \times  x_{\rm B, \ sp} $$


### Attitude control

The entire process of attitude control is roughly as follows:


#### Step 1: Perform quaternion operations to obtain $q_{\rm red, \ sp }$, representing only the roll & pitch errors, and $q_{\rm mix}$, representing only the yaw error.

$$q_{\rm red, \ sp}= q_{\rm z} \otimes q_{\rm z, sp}$$

where $q_{\rm z}$ and $q_{\rm z, \ sp}$ are the quaternions of the current body z-axis and desired body z-axis. Kronecker product will calculate the difference quaternion. 

$q_{\rm mix}$ represents the quaternion rotation from the intermediate state $q_{\rm red, \ sp}$ to the desired attitude $q_{\rm sp}$, expressed in the $q_{\rm red, \ sp}$ reference frame, and it can characterize the error in yaw, which is given below:

$$q_{\rm mix} = q_{\rm red, \ sp}^{-1} \cdot q_{\rm sp}$$


#### Step 2: Use $w= {\rm \_yaw\_w} = {\rm MC\_YAW\_WEIGHT}$  to modify $q_{\rm mix}$, reducing the calculated yaw error, resulting in a decrease in the final calculated yaw's desired angular velocity.

Since the z-axis of the intermediate state $q_{\rm red, \ sp}$ coordinate system coincides with the z-axis of the desired attitude $q_{\rm sp}$ coordinate system, the representation of $q_{\rm mix}$ in the $q_{\rm red, sp}$ reference frame should be

$$q_{\rm mix}=(\cos\frac{\psi_{\rm e}}{2},0,0,\sin\frac{\psi_{e}}{2})$$

where $\psi_{\rm e}$ indicates the error in yaw. It is constrained by $w={\rm MC\_YAW\_WEIGHT}$, which is used to represent the degree of priority for controlling roll and pitch, ranging from [0, 1]. 

$$q_{\rm mix}^*=(\cos\frac{w\psi_{\rm e}}{2},0,0,\sin\frac{w\psi_{e}}{2})$$


Thus error of yaw has been reduced.  


#### Step 3. Synthesize a new desired attitude from qd_red and q_mix. Calculate the total error using this new desired attitude, apply P+feedforward, and obtain the desired angular velocity. 

$$q_{\rm e} = q_{\rm red,sp}^{-1} \cdot q_{\rm mix}^*$$

$q_{\rm e}$ represents the quaternion rotation from q to qd, expressed in the body coordinate system, denoting the error. The desired three-axis angular velocity is obtained by multiplying the error with the P parameter.

$$\begin{bmatrix} 
p_{\rm sp} \\ 
q_{\rm sp} \\ 
r_{\rm sp} 
\end{bmatrix} =
\begin{bmatrix} 
K_{\rm p, roll} & 0 & 0 \\ 
0 & K_{\rm p, pitch} & 0 \\  
0 & 0 & K_{\rm p, yaw} 
\end {bmatrix}
2{\rm sign}(q_{\rm e}(1)) 
\begin{bmatrix} 
q_{\rm e}(2) \\ 
q_{\rm e}(3) \\ 
q_{\rm e}(4) 
\end{bmatrix}$$

The control paramters are given as follow:

| Control Paramter          |     PX4 Parameter        | Value       |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm p, roll}$         | MC\_ROLL\_P              | 11.5         |
| $K_{\rm p, pitch}$        | MC\_PITCH\_P             | 6.5         |
| $K_{\rm p, yaw}$          | MC\_YAW\_P               | 2.8         |


### Angular Rate Control
Obtaining angular rate error, the desired angular rate is generated by attitude angle control. The formula for angular rate PID control is as follows:

$$
\begin{bmatrix}
\delta_{\rm ali} \\ 
\delta_{\rm ele} \\ 
\delta_{\rm rud}
\end{bmatrix} =
K_{\rm p, \ \Omega}(\Omega_{\rm sp} - \Omega) + 
K_{\rm i, \ \Omega}\int(\Omega_{\rm sp}-\Omega)dt + 
K_{\rm d, \ \Omega}(-\dot{\Omega}) + 
K_{\rm ff}{\Omega}_{\rm sp}
$$

where $K_{\rm p, \ \Omega} = {\rm diag}(K_{\rm p, p}, K_{\rm p, q}, K_{\rm p, r})$,  $K_{\rm i, \ \Omega} = {\rm diag}(K_{\rm i, p}, K_{\rm i, q}, K_{\rm i, r})$,  and $K_{\rm d, \ \Omega} = {\rm diag}(K_{\rm d, p}, K_{\rm d, q}, K_{\rm d, r})$. 


| Control Paramter          |     PX4 Parameter        | Value       |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm p, p}$            | MC\_ROLLRATE\_P          | 0.055       |
| $K_{\rm p, q}$            | MC\_PITCHRATE\_P         | 0.06        |
| $K_{\rm p, r}$            | MC\_YAWRATE\_P           | 0.2      |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm i, p}$            | MC\_ROLLRATE\_I          | 0.2         |
| $K_{\rm i, q}$            | MC\_PITCHRATE\_I         | 0.2         |
| $K_{\rm i, r}$            | MC\_YAWRATE\_I           | 0.1      |
|-------------------------- | ------------------------ | ----------- |
| $K_{\rm d, p}$            | MC\_ROLLRATE\_D          | 0.0005        |
| $K_{\rm d, q}$            | MC\_PITCHRATE\_D         | 0.0005         |
| $K_{\rm d, r}$            | MC\_YAWRATE\_D           | 0.0         |


## Dynamic Model

The dynamic model is developed based on NUSWARM drone platform. The detailed explanation can be found the report of 
